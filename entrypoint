#!/bin/bash

set -e

if [[ -d "docker-entrypoint.d" ]]; then
  echo "Running docker-entrypoint.d files in background"
  /bin/run-parts docker-entrypoint.d &
  ENTRYPOINT_PID=$!
fi

exec "$@" &
DOCKER_PID=$!

if [[ -n "$ENTRYPOINT_PID" ]]; then
  wait $ENTRYPOINT_PID
  echo "Entrypoint scripts completed"
fi

sleep 2
for i in {1..15}; do
  if docker info >/dev/null 2>&1; then
    echo "Docker is ready"
    break
  fi
  echo "Waiting for Docker to start... ($i/15)"
  sleep 1
done

# Now start the proxy
python3 /app/proxy.py